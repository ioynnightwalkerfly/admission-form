import streamlit as st
import requests
from datetime import datetime

# ==========================================
# ‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ LINE
# ==========================================
LINE_TOKEN = "Gaow3ZPWwaqdrBsLWEF54B6xlMmrls4NV1exzMjShgmWQS6bsCWyxlPm6tli+MY4ImenfaWuiNnse1Q3QaGl7Pj9c8u79m6PXZkRZuwr4J5/DKd6yw0zLz1yQL62EmXMnC94YGgBi/1CX4ZTxbeSXwdB04t89/1O/w1cDnyilFU="
GROUP_ID = "Ca5467fb421c7c3878130f77530617627"
# ==========================================

def send_line_message(message):
    url = 'https://api.line.me/v2/bot/message/push'
    headers = {'Content-Type': 'application/json', 'Authorization': f'Bearer {LINE_TOKEN}'}
    data = {"to": GROUP_ID, "messages": [{"type": "text", "text": message}]}
    return requests.post(url, headers=headers, json=data)

# --- ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö ---
st.set_page_config(page_title="‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£ (Admin)", page_icon="üéì", layout="centered")

# --- CSS ‡∏ï‡∏Å‡πÅ‡∏ï‡πà‡∏á‡∏õ‡∏∏‡πà‡∏° ---
st.markdown("""
    <style>
    .stButton>button {
        width: 100%;
        border-radius: 20px;
        height: 50px;
        font-weight: bold;
    }
    </style>
    """, unsafe_allow_html=True)

st.title("üéì ‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£ (Admin)")
st.caption("‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£")

# --- ‡πÉ‡∏ä‡πâ Session State ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ ---
if 'form_submitted' not in st.session_state:
    st.session_state.form_submitted = False

# --- ‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ---
with st.form("admission_form", clear_on_submit=True):
    st.subheader("1. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤")
    
    col1, col2 = st.columns(2)
    with col1:
        student_name = st.text_input("üë§ ‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•", placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢...")
        # [NEW] ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡πà‡∏≠‡∏á‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
        school_name = st.text_input("üè´ ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏î‡∏¥‡∏°", placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏£‡∏£.‡∏£‡∏≤‡∏ä‡∏™‡∏µ‡∏°‡∏≤‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏•‡∏±‡∏¢")
        
    with col2:
        gpax = st.text_input("üìä ‡πÄ‡∏Å‡∏£‡∏î‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ (GPAX)", placeholder="‡πÄ‡∏ä‡πà‡∏ô 3.50")
        phone = st.text_input("üìû ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå", placeholder="08x-xxx-xxxx")
    
    # ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏°‡∏±‡∏Ñ‡∏£ (‡πÄ‡∏≠‡∏≤‡πÑ‡∏ß‡πâ‡πÅ‡∏ñ‡∏ß‡∏•‡πà‡∏≤‡∏á‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß)
    apply_time = st.text_input("üïí ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏°‡∏±‡∏Ñ‡∏£", value=datetime.now().strftime("%d/%m/%Y %H:%M"))

    st.subheader("2. ‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£")
    drive_link = st.text_input("üîó ‡∏•‡∏¥‡∏á‡∏Å‡πå Google Drive (‡∏£‡∏ß‡∏°‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£)", placeholder="https://drive.google.com/...")
    
    st.markdown("**‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÅ‡∏ô‡∏ö‡∏°‡∏≤:**")
    c1, c2 = st.columns(2)
    with c1:
        doc_photo = st.checkbox("‡∏£‡∏π‡∏õ‡∏ñ‡πà‡∏≤‡∏¢ 1 ‡∏ô‡∏¥‡πâ‡∏ß")
        doc_idcard = st.checkbox("‡∏™‡∏≥‡πÄ‡∏ô‡∏≤‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô")
        doc_house = st.checkbox("‡∏™‡∏≥‡πÄ‡∏ô‡∏≤‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ö‡πâ‡∏≤‡∏ô")
        doc_parents = st.checkbox("‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ö‡πâ‡∏≤‡∏ô ‡∏ö‡∏¥‡∏î‡∏≤/‡∏°‡∏≤‡∏£‡∏î‡∏≤")
    with c2:
        doc_transcript = st.checkbox("‡πÉ‡∏ö ‡∏õ‡∏û.1 (Transcript)")
        doc_portfolio = st.checkbox("‡πÅ‡∏ü‡πâ‡∏°‡∏™‡∏∞‡∏™‡∏°‡∏ú‡∏•‡∏á‡∏≤‡∏ô (Portfolio)")
        doc_scores = st.checkbox("‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏≠‡∏ö (IELTS/9 ‡∏ß‡∏¥‡∏ä‡∏≤)")
        doc_slip = st.checkbox("‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô")

    st.markdown("---")
    
    # --- ‡∏à‡∏±‡∏î‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡πà‡∏á‡πÑ‡∏•‡∏ô‡πå ---
    docs_list = []
    if doc_photo: docs_list.append("- ‡∏£‡∏π‡∏õ‡∏ñ‡πà‡∏≤‡∏¢")
    if doc_idcard: docs_list.append("- ‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô")
    if doc_house: docs_list.append("- ‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ö‡πâ‡∏≤‡∏ô")
    if doc_parents: docs_list.append("- ‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ö‡πâ‡∏≤‡∏ô ‡∏û‡πà‡∏≠‡πÅ‡∏°‡πà")
    if doc_transcript: docs_list.append("- Transcript")
    if doc_portfolio: docs_list.append("- Portfolio")
    if doc_scores: docs_list.append("- ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏≠‡∏ö")
    if doc_slip: docs_list.append("- ‡∏™‡∏•‡∏¥‡∏õ‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô")
    
    docs_text = "\n".join(docs_list) if docs_list else "- (‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÅ‡∏ô‡∏ö)"
    
    # [UPDATE] ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏•‡∏á‡πÉ‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
    final_msg = f"""üîî ‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÉ‡∏´‡∏°‡πà (‡∏£‡∏±‡∏ö‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÇ‡∏î‡∏¢‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà)
----------------------------
üë§ ‡∏ä‡∏∑‡πà‡∏≠: {student_name}
üè´ ‡∏£‡∏£.: {school_name if school_name else "-"}
üìä ‡πÄ‡∏Å‡∏£‡∏î: {gpax}
üìû ‡πÇ‡∏ó‡∏£: {phone}
üïí ‡πÄ‡∏ß‡∏•‡∏≤: {apply_time}
----------------------------
üìÇ ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö:
{docs_text}

üîó ‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£:
{drive_link if drive_link else "(‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏•‡∏¥‡∏á‡∏Å‡πå)"}
"""

    # ‡∏õ‡∏∏‡πà‡∏°‡∏™‡πà‡∏á
    submitted = st.form_submit_button("üöÄ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô")

    if submitted:
        if not student_name:
            st.error("‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤!")
        else:
            try:
                res = send_line_message(final_msg)
                if res.status_code == 200:
                    st.success(f"‚úÖ ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á '{student_name}' ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!")
                    st.balloons()
                else:
                    st.error(f"‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: {res.text}")
            except Exception as e:
                st.error(f"‚ùå Error: {e}")